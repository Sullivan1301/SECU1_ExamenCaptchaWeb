<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECU1 - Examen Captcha Web</title>
    <script type="text/javascript" src="https://b82b1763d1c3.ef7ef6cc.eu-west-3.captcha.awswaf.com/b82b1763d1c3/jsapi.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #sequence { margin-top: 20px; max-height: 300px; overflow-y: auto; list-style-type: none; padding: 0; }
        #sequence li { padding: 5px 0; }
    </style>
</head>
<body>
<h1>Générateur de Séquence</h1>
<form id="numberForm">
    <label for="numberInput">Entrez un nombre entre 1 et 1000 :</label>
    <input type="number" id="numberInput" min="1" max="1000" required>
    <button type="submit">Lancer</button>
</form>

<ul id="sequence"></ul>

<div id="my-captcha-container" style="margin-top: 20px; display: none;">
    <!-- Captcha widget sera affiché ici -->
</div>

<script>
    const apiKey = "...API key goes here..."; // Remplacez par l'API Key fournie
    const wafUrl = "https://api.prod.jcloudify.com/whoami";

    document.getElementById('numberForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const N = parseInt(document.getElementById('numberInput').value, 10);
        runSequence(N);
    });

    async function runSequence(N) {
        const sequenceDiv = document.getElementById('sequence');
        sequenceDiv.innerHTML = ''; // Clear sequence list
        for (let i = 1; i <= N; i++) {
            const success = await fetchWithCaptcha(i, sequenceDiv);
            if (!success) {
                break; // Stop execution if CAPTCHA fails
            }
            await delay(1000); // Delay of 1 second between requests
        }
    }

    async function fetchWithCaptcha(index, sequenceDiv) {
        try {
            const response = await fetch(wafUrl);
            if (response.ok) {
                addListItem(sequenceDiv, `${index}. Forbidden`);
                return true;
            } else if (response.status === 403) {
                // CAPTCHA detected
                return await showCaptcha(sequenceDiv, index);
            }
        } catch (error) {
            console.error('Erreur lors de la requête :', error);
        }
        return false;
    }

    function showCaptcha(sequenceDiv, index) {
        return new Promise((resolve) => {
            const container = document.querySelector("#my-captcha-container");
            container.style.display = 'block'; // Display CAPTCHA container
            AwsWafCaptcha.renderCaptcha(container, {
                apiKey: apiKey,
                onSuccess: (wafToken) => {
                    container.style.display = 'none'; // Hide CAPTCHA container
                    AwsWafIntegration.fetch(wafUrl, {
                        method: "POST",
                        headers: {
                            'Authorization': `Bearer ${wafToken}`,
                        }
                    }).then(() => {
                        addListItem(sequenceDiv, `${index}. CAPTCHA Passed`);
                        resolve(true); // Continue sequence
                    }).catch((error) => {
                        console.error('Erreur lors de la résolution du CAPTCHA :', error);
                        resolve(false); // Stop sequence
                    });
                },
                onError: (error) => {
                    console.error('Erreur avec le CAPTCHA :', error);
                    resolve(false); // Stop sequence
                },
            });
        });
    }

    function addListItem(container, text) {
        const listItem = document.createElement('li');
        listItem.textContent = text;
        container.appendChild(listItem);
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
</script>
</body>
</html>
