<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECU1 - Examen Captcha Web</title>
    <script type="text/javascript" src="https://b82b1763d1c3.ef7ef6cc.eu-west-3.captcha.awswaf.com/b82b1763d1c3/jsapi.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #output { margin-top: 20px; max-height: 300px; overflow-y: auto; font-family: monospace; }
        #output div { margin-bottom: 5px; }
    </style>
</head>
<body>
<h1>Générateur de Séquence</h1>
<form id="numberForm">
    <label for="numberInput">Entrez un nombre entre 1 et 1000 :</label>
    <input type="number" id="numberInput" min="1" max="1000" required>
    <button type="submit">Lancer</button>
</form>

<div id="output" style="display: none;"></div>
<div id="my-captcha-container" style="margin-top: 20px; display: none;">
    <!-- Captcha widget sera affiché ici -->
</div>

<script>
    const apiKey = "...API key goes here..."; // Remplacez par l'API Key fournie
    const wafUrl = "https://api.prod.jcloudify.com/whoami";

    document.getElementById('numberForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const N = parseInt(document.getElementById('numberInput').value, 10);

        // Masquer le formulaire et afficher la zone de sortie
        document.getElementById('numberForm').style.display = 'none';
        const outputDiv = document.getElementById('output');
        outputDiv.style.display = 'block';

        runSequence(N, outputDiv);
    });

    async function fetchWithCaptcha(index, tempLine) {
        try {
            const response = await fetch(wafUrl);

            if (response.ok) {
                // Si la réponse est OK (statut 200), on affiche "Forbidden"
                updateOutputLine(tempLine, `${index}. Forbidden`);
                return true;
            } else if (response.status === 403) {
                // Si le statut est 403 (Forbidden), on affiche "Forbidden"
                updateOutputLine(tempLine, `${index}. Forbidden`);
                return true;
            } else if (response.status === 405) {
                // Si le statut est 405 (Method Not Allowed), on affiche un CAPTCHA
                return await showCaptcha(tempLine, index);
            } else {
                // Si on reçoit un autre statut HTTP, on l'ignore ou on peut gérer ici si besoin
                return false;
            }
        } catch (error) {
            console.error('Erreur lors de la requête :', error);
        }
        return false;
    }

    async function runSequence(N, outputDiv) {
        outputDiv.innerHTML = ''; // Réinitialiser la sortie
        for (let i = 1; i <= N; i++) {
            // Ajouter une ligne temporaire avec "En attente" au début
            const tempLine = addOutputLine(outputDiv, `${i}. En attente...`);

            // Effectuer la requête et gérer le succès ou l'échec
            const success = await fetchWithCaptcha(i, tempLine);
            if (!success) {
                addOutputLine(outputDiv, "Processus interrompu. Réessayez plus tard.");
                break;
            }

            // Attendre 1 seconde entre chaque requête
            await delay(1000);
        }
    }

    function showCaptcha(tempLine, index) {
        return new Promise((resolve) => {
            const container = document.querySelector("#my-captcha-container");
            container.style.display = 'block'; // Afficher le conteneur CAPTCHA

            // Ici, vous utilisez l'API du CAPTCHA pour résoudre le CAPTCHA
            AwsWafCaptcha.renderCaptcha(container, {
                apiKey: apiKey,
                onSuccess: (wafToken) => {
                    container.style.display = 'none'; // Masquer le CAPTCHA après validation

                    // Faire une nouvelle requête avec le token CAPTCHA
                    AwsWafIntegration.fetch(wafUrl, {
                        method: "POST",
                        headers: {
                            'Authorization': `Bearer ${wafToken}`,
                        }
                    }).then(() => {
                        // Une fois le CAPTCHA validé, mettre à jour la ligne avec "Forbidden"
                        updateOutputLine(tempLine, `${index}. Forbidden`);
                        resolve(true); // Continuer la séquence
                    }).catch((error) => {
                        console.error('Erreur lors de la résolution du CAPTCHA :', error);
                        resolve(false); // Arrêter la séquence en cas d'erreur
                    });
                },
                onError: (error) => {
                    console.error('Erreur avec le CAPTCHA :', error);
                    resolve(false); // Arrêter la séquence en cas d'erreur
                },
            });
        });
    }

    function addOutputLine(container, text) {
        const line = document.createElement('div');
        line.textContent = text;
        container.appendChild(line);
        return line; // Retourner une référence pour mise à jour
    }

    function updateOutputLine(line, text) {
        line.textContent = text; // Mettre à jour le contenu de la ligne
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
</script>
</body>
</html>
